---
title: "Reproducible Research- Peer Assessment 2: A Study of Severe Weather Events and Their Negative Consequences"
output: 
  html_document:
    keep_md: true
---

##<font color=blue>Synopsis</font>###
Severe weather events often happen without warning and are traumatic-  they wreak havoc and destroy property and lives.  Officials need to know where to efficiently mobilize limited resources to assist with protective actions and cleanup efforts.  This analysis, while making no suggestions, takes a dataset compiled across the U.S. from 1950 - 2011 and aims to answer two questions related to damages caused by these events:

1.) Across the United States, which types of events (as indicated in the EVTYPE variable) are most harmful with respect to population health?

2.) Across the United States, which types of events have the greatest economic consequences?

From this analysis, we find the most expensive storm events in terms of population health (fatalities and injuries) were tornadoes and high wind events.  The storm events that caused the greatest economic consequences were floods and hurricanes.  


##<font color=blue>Data Processing</font>

###Obtaining the Data###

The [dataset](https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2) is downloaded from the U.S. National Oceanic and Atmospheric Administration's (NOAA) storm database and read in to a dataframe called 'data'.  
```{r cache=TRUE}
temp <- tempfile()
download.file("http://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2", temp)
data <- read.csv(temp, stringsAsFactors=FALSE)
unlink(temp)
```

It takes several minutes to download and read in the file, it must be large.  We check to see how large exactly (902,297 rows with 37 columns) and look at the first few rows of the dataset.
```{r}
dim(data)
```


```{r}
head(data[,1:7])
```

###Processing the Data###

From the 7 columns we just saw it's evident there will be unnecessary columns we can pare from a refined dataset.  But before we manipulate the data we need to load the necessary packages.  Note, if you haven't downloaded one or more of these packages you can by running the following code.
```{r eval=FALSE}
install.packages('plyr')
install.packages('dplyr')
install.packages('lubridate')
install.packages('tidyr')
install.packages('ggplot2')

```

```{r message=FALSE, warning=FALSE}
library(plyr)
library(dplyr)
library(lubridate)
library(tidyr)
library(ggplot2)
```

Using the National Weather Service [Storm Data Documentation](https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf) and the National Climatic Data Center Storm Events [FAQ](https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2FNCDC%20Storm%20Events-FAQ%20Page.pdf) as guides, the columns needed to analyze the data for the questions presented are selected to a refined dataframe called **'pData'**. The columns selected are <font color=orange>BGN_DATE</font> (date of event), <font color=orange>EVTYPE</font> (event type), <font color=orange>FATALITIES</font> (# of fatalities), <font color=orange>INJURIES</font> (# of injuries), <font color=orange>PROPDMG</font> (dollar amount of property damage), <font color=orange>PROPDMGEXP</font> (exponent for PROPDMG in thousands(K), millions(M), or billions(B)+), <font color=orange>CROPDMG</font> (dollar amount of property damage), and <font color=orange>CROPDMGEXP</font> (exponent for CROPDMG in thousands(K), millions(M), or billions(B)+). <br>

+as documented on page 12 section 2.7 of [Storm Data Documentation](https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf)
```{r}
pData <- select(data, BGN_DATE, EVTYPE, FATALITIES, INJURIES, PROPDMG, PROPDMGEXP, CROPDMG, CROPDMGEXP)
```

Next we clean up the BGN_DATE column by just keeping the year and renaming the column YEAR. 
```{r}
#use lubridate package to coerce BGN_DATE column from character to POSIXct
pData$BGN_DATE <- mdy_hms(pData$BGN_DATE)

#coerce to POSIXlt so the date and time are split into different components
pData$BGN_DATE <- as.POSIXlt(pData$BGN_DATE, format="%m/$d/$Y")

#keep just the year component
pData$BGN_DATE <- pData$BGN_DATE$year+1900
colnames(pData)[1] <- "YEAR"
```

Let's take a look at the result and make sure it's what we want.
```{r}
head(pData)
```

Now to organize the event types in 'EVTYPE'.  We can see the data in this column are a mess.  There was a lack of an uniform approach to entering the type of event that occured.  First, the rows containing SUMMARY information need to be deleted.  Then the EVTYPE column needs to be classified into the following major weather events-  TORNADO, WIND, HAIL, RAIN, WINTER WEATHER, STORM, FLOOD, HURRICANE, DUST, COLD, HOT, DRY, FOG, LIGHTNING, SURF, AVALANCHE, and FIRE.  The classification will happen by a brute force matching of case insensitive partial words being renamed into one of those 17 major weather events.  While quite an imperfect method, it serves to accurately match and keep over 99% of the data. After the classifications have been adjusted we take just those observations (rows) that contain one of those 17 classifications and delete the rest of those rows.  
```{r}

#Deleting the rows with Summary information
a <- grepl("summary", pData$EVTYPE, ignore.case=TRUE)
pData <- pData[!a,]

#CLASSIFICATIONS
#TORNADO:  matches against 'torn', 'spout', or 'funn'
a <- grep("torn|spout|funn", pData$EVTYPE, ignore.case=TRUE)
pData[a,2] <- "TORNADO"

#WIND: matches against 'wind', 'wnd', or 'gust'
a <- grep("wind|wnd|gust", pData$EVTYPE, ignore.case=TRUE)
pData[a,2] <- "WIND"

#HAIL: matches against 'hail'
a <- grep("hail", pData$EVTYPE, ignore.case=TRUE)
pData[a,2] <- "HAIL"

#RAIN: matches with 'rain' or 'wet'
a <- grep("rain|wet", pData$EVTYPE, ignore.case=TRUE)
pData[a,2] <- "RAIN"

#WINTER WEATHER: matches with 'snow', 'ice', icy', 'wint', 'sleet', 'driz', 'fros', or 'bliz
a <- grep("snow|ice|icy|wint|sleet|bliz|fros|driz", pData$EVTYPE, ignore.case=TRUE)
pData[a,2] <- "WINTER WEATHER"

#STORM: matches with 'storm'
a <- grep("storm", pData$EVTYPE, ignore.case=TRUE)
pData[a,2] <- "STORM"

#FLOOD: matches with 'flash', 'fld', 'flood', or 'tsun' 
a <- grep("flash|flood|fld|tsun", pData$EVTYPE, ignore.case=TRUE)
pData[a,2] <- "FLOOD"

#HURRICANE: matches with 'hurr' or 'typh'
a <- grep("hurr|typh", pData$EVTYPE, ignore.case=TRUE)
pData[a,2] <- "HURRICANE"

#DUST: matches with 'dust'
a <- grep("dust", pData$EVTYPE, ignore.case=TRUE)
pData[a,2] <- "DUST"

#COLD: matches with 'freez', 'cold', 'low temp', or hypother'
a <- grep("freeze|cold|hypother|low temp", pData$EVTYPE, ignore.case=TRUE)
pData[a,2] <- "COLD"

#HOT: matches with 'warm', 'hot', 'high temp', or 'heat'
a <- grep("warm|hot|high temp|heat", pData$EVTYPE, ignore.case=TRUE)
pData[a,2] <- "HOT"

#DRY: matches with 'dry' or 'droug' 
a <- grep("dry|droug", pData$EVTYPE, ignore.case=TRUE)
pData[a,2] <- "DRY"

#FOG: matches with 'fog'
a <- grep("fog", pData$EVTYPE, ignore.case=TRUE)
pData[a,2] <- "FOG"

#LIGHTNING: matches 'light'
a <- grep("light", pData$EVTYPE, ignore.case=TRUE)
pData[a,2] <- "LIGHTNING"

#SURF: matches 'surf', 'tide', 'wave', 'rip', 'surg', or 'swell'
a <- grep("surf|tide|wave|rip|surg|swell", pData$EVTYPE, ignore.case=TRUE)
pData[a,2] <- "SURF"

#AVALANCHE: matches 'ava'
a <- grep("ava", pData$EVTYPE, ignore.case=TRUE)
pData[a,2] <- "AVALANCHE"

#FIRE: matches 'fire', 'smoke', or 'ash'
a <- grep("fire|smoke|ash", pData$EVTYPE, ignore.case=TRUE)
pData[a,2] <- "FIRE"


#Deleting the rows without one of the 17 classifications in EVTYPE
a <- grepl("tornado|wind|hail|rain|winter weather|storm|flood|hurricane|dust|cold|hot|dry|fog|lightning|surf|avalanche|fire", pData$EVTYPE, ignore.case=TRUE)
pData <- pData[a,]
```

To analyze which events are most harmful with respect to population health (as measured by the columns 'FATALITIES' and 'INJURIES') we create a new dataframe *(pDataPop)* that subsets for only those rows that have at least 1 fatality or at least 1 injury. We then keep only the relevant columns and gather the data so it's organized specifically to evaluate the specific harmfulness of each type of event. Specifically, the INJURIES and FATALITIES columns are combined under a CASUALTY column with factors of INJURIES or FATALITIES. 
```{r}
pDataPop <- subset(pData, FATALITIES < 1 | INJURIES < 1)
pDataPop <- pDataPop[,c("EVTYPE", "FATALITIES", "INJURIES")]
```

This then sums the number of types of casualties (injuries vs fatalities) for each weather event.
```{r}
pDataPop <- tbl_df(pDataPop)
by_EVTYPE <- group_by(pDataPop, EVTYPE)
Pop <- summarize(by_EVTYPE, FATALITIES=sum(FATALITIES), INJURIES=sum(INJURIES))
Pop <- gather(Pop, Casualty, Count, -EVTYPE)
```

Next, in order to analyze which events have the greatest economic consequences, we create a dataframefor those rows that have a value of 'K', 'k', 'M', 'm', 'B', or 'b' in either the PROPDMGEXP column or CROPDMGEXP column.  Any rows that don't have those values in one of those columns are irrelevant since they don't contain dollar damage amounts, or the amounts are not at least $1,000 at which point they are negligible for the purposes of this analysis.  
```{r}
#subset by PROPDMGEXP and CROPDMGEXP to create a dataframe relevant to economic damage
pDataEcon <- subset(pData, PROPDMGEXP == "K" | PROPDMGEXP == "k" | PROPDMGEXP == "M" | PROPDMGEXP == "m" | PROPDMGEXP == "B" | PROPDMGEXP == "b" | CROPDMGEXP == "K" | CROPDMGEXP == "k" | CROPDMGEXP == "M" | CROPDMGEXP == "m" | CROPDMGEXP == "B" | CROPDMGEXP == "b")
```

Now we add columns that multiply the PROPDMG and PROPDMGEXP columns and the CROPDMG and CROPDMGEXP columns respectively to get dollar amounts for each event. Note:  Powers adjusted per 1000.   
```{r}
#replacing PROPDMGEXP variables with numbers according to their power, per 1000
#replacing 'K' or 'k' with 1
a <- grep("K|k", pDataEcon$PROPDMGEXP, ignore.case=TRUE)
pDataEcon[a,6] <- "1"

#replacing 'M' or 'm' with 1000
a <- grep("M|m", pDataEcon$PROPDMGEXP, ignore.case=TRUE)
pDataEcon[a,6] <- "1000"

#replacing 'B' or 'b' with 1000000
a <- grep("B|b", pDataEcon$PROPDMGEXP, ignore.case=TRUE)
pDataEcon[a,6] <- "1000000"

#coercing PROPDMGEXP to integers
pDataEcon$PROPDMGEXP <- as.integer(pDataEcon$PROPDMGEXP)

#creating new column that multiplies PROPDMG and PROPDMGEXP called PROPTOTAL
pDataEcon$PROPTOTAL <- pDataEcon$PROPDMG * pDataEcon$PROPDMGEXP

#replacing CROPDMGEXP variables with numbers according to their power, per 1000
#replacing 'K' or 'k' with 1
a <- grep("K|k", pDataEcon$CROPDMGEXP, ignore.case=TRUE)
pDataEcon[a,8] <- "1"

#replacing 'M' or 'm' with 1000
a <- grep("M|m", pDataEcon$CROPDMGEXP, ignore.case=TRUE)
pDataEcon[a,8] <- "1000"

#replacing 'B' or 'b' with 1000000
a <- grep("B|b", pDataEcon$CROPDMGEXP, ignore.case=TRUE)
pDataEcon[a,8] <- "1000000"

#coercing CROPDMGEXP to integers
pDataEcon$CROPDMGEXP <- as.integer(pDataEcon$CROPDMGEXP)

#creating new column that multiplies CROPDMG and CROPDMGEXP called CROPTOTAL
pDataEcon$CROPTOTAL <- pDataEcon$CROPDMG * pDataEcon$CROPDMGEXP
```

Checking to see the new columns look right.
```{r}
head(pDataEcon)
```

Now we subset pDataEcon into a dataframe called Econ that contains just the columns we need to assess which event types cause the most economic damage.  The columns we'll need are EVTYPE, PROPTOTAL (dollar amount of total property damage, per $1000), and CROPTOTAL (dollar amount of total crop damage, per $1000)
```{r}
Econ <- pDataEcon[,c("EVTYPE", "PROPTOTAL", "CROPTOTAL")]
head(Econ)
```

This then sums the damage amounts in dollars per 1000 (crops vs properties) for each weather event.
```{r}
Econ <- tbl_df(Econ)
by_EVTYPE <- group_by(Econ, EVTYPE)
Econ <- summarize(by_EVTYPE, PROP=sum(PROPTOTAL, na.rm=TRUE), CROP=sum(CROPTOTAL, na.rm=TRUE))
Econ <- gather(Econ, Type, Dollars, -EVTYPE)
```

##<font color=blue>Analyzing the Data</font>

Let's build a barplot to see which types of events are most harmful with respect to population health.
```{r}
plot <- ggplot(Pop, aes(EVTYPE, Count)) + geom_bar(stat="identity", aes(fill=Casualty)) + labs(title = "Casualties for Major Weather Events in the U.S., 1950 - 2011", x = "Event Type", y = "# Casualties") + labs(color = "Type of Casualty") + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
print(plot)
```

Now let's take a look at a barplot to see which weather events are the most harmful in terms of property and crop damage in dollar amounts. 
```{r}
plot <- ggplot(Econ, aes(EVTYPE, Dollars)) + geom_bar(stat="identity", aes(fill=Type)) + labs(title = "Property and Crop Damages- Major Weather Events, USA 1950 - 2011", x = "Event Type", y = "$ Damages, per $1000") + labs(color = "Type of Damage") + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
print(plot)
```


##<font color=blue>Results</font>
This analysis endeavors to answer two questions:
1.) Across the United States, which types of events (as indicated in the EVTYPE variable) are most harmful with respect to population health?

2.) Across the United States, which types of events have the greatest economic consequences?

**QUESTION 1**
From 1950 - 2011 the highest amount of Total Casualties (Fatalities + Injuries) were suffered from tornadic events (~32,000).  The second highest amount of Total Casualties was also attributable to high winds (~11,000), but the amount of casualties for that event was less than 35% of tornadic casualties.  Rounding out the top 6 events in order for Total Casualties were floods (3rd most at ~7,000), extreme heat (~5,000), lightning (~5,000), and winter weather (~3,000).  

In terms of Injuries, the top 6 descending from most Injuries first reads the same as Total Casualties, except for lightning and extreme heat swapping places in the order. 

In terms of Fatalities, the top 6 descending from most Fatalities first reads as such:  extreme heat (~2,500), floods (~1,200), high winds (~1,000), surf (~600), lightning, (~500), and tornadoes (~400).   

**QUESTION 2**
From 1950 - 2011 the highest amount of Total Damages (Property + Crop) were suffered from floods (slightly less than $180 billion, not adjusted for inflation).  Second through sixth on the list, in order, are hurricanes (~$90 billion), tornadoes (~$59 billion), storms (~$57 billion), winter weather (~$19 billion), and high winds (~$18.2 billion).

In terms of Property Damage amounts, the top six are floods (~$167 billion), hurricanes (~$85 billion), tornadoes (~$58 billion), storms (~$56 billion), high winds (~$16.1 billion), and hail (~$16 billion).

In terms of Crop Damage amounts, the top six are dry and drought conditions (~$14 billion), floods (~$~12 billion), winter weather (~$6.5 billion), hurricanes (~$5.5 billion), hail (~$3 billion), and high winds (~$2 billion). 